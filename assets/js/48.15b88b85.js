(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{329:function(t,e,s){"use strict";s.r(e);var a=s(14),n=Object(a.a)({},(function(){var t=this,e=t._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),e("p",[t._v("终于遇到一个简单的库来学习它的源码了。这个项目只有2个主要文件，代码加起来不到500行，是真的很mini了。\n客户端向服务端发起请求用"),e("code",[t._v("xhr")]),t._v("或"),e("code",[t._v("fetch")]),t._v("，客户端与服务端双向通信用"),e("code",[t._v("websocket")]),t._v("，而服务端主动发起请求用"),e("code",[t._v("sse")]),t._v("。"),e("code",[t._v("chatGPT")]),t._v("就是用"),e("code",[t._v("sse")]),t._v("回复提问的。"),e("br"),t._v(" "),e("code",[t._v("window")]),t._v("中有一个叫"),e("code",[t._v("EventSource")]),t._v("的构造函数。一个"),e("code",[t._v("EventSource")]),t._v("实例会对服务器开启一个持久化的连接，以"),e("code",[t._v("text/event-stream")]),t._v("格式发送事件，此连接会一直保持开启直到通过调用"),e("code",[t._v("EventSource.close()")]),t._v("关闭。但使用"),e("code",[t._v("EventSource")]),t._v("时只能把参数加到"),e("code",[t._v("url")]),t._v("后面，而且也不能像"),e("code",[t._v("fetch")]),t._v("请求那样设置"),e("code",[t._v("header")]),t._v("等参数。借助"),e("code",[t._v("fetch-event-source")]),t._v("这个库就可以像发起"),e("code",[t._v("fetch")]),t._v("请求一样发起服务器单向通信请求。")]),t._v(" "),e("h1",{attrs:{id:"目录结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#目录结构"}},[t._v("#")]),t._v(" 目录结构")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chendx97/CPics/img/12dd0f1f322e466893e0def92d4d8f1e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp",alt:"1.webp"}})]),t._v(" "),e("h1",{attrs:{id:"入口文件"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#入口文件"}},[t._v("#")]),t._v(" 入口文件")]),t._v(" "),e("p",[e("code",[t._v("index.ts")]),t._v("是入口文件，里面只有2行代码，导出了"),e("code",[t._v("fetch.ts")]),t._v("和"),e("code",[t._v("parse.ts")]),t._v("中部分变量和方法。")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" fetchEventSource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" FetchEventSourceInit"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EventStreamContentType "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./fetch'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" EventSourceMessage "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./parse'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[e("code",[t._v("export {...} from 'xx'")]),t._v("其实是"),e("code",[t._v("import")]),t._v(" + "),e("code",[t._v("export")]),t._v("的缩写。、\n上面的代码其实就是下面代码的缩写：")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" fetchEventSource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" FetchEventSourceInit"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" EventStreamContentType "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./fetch'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" EventSourceMessage "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./parse'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tfetchEventSource"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tFetchEventSourceInit"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tEventStreamContentType"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\tEventSourceMessage"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("h1",{attrs:{id:"发起请求"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#发起请求"}},[t._v("#")]),t._v(" 发起请求")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chendx97/CPics/img/569c4d3e662449c594ca9b57531af51e~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp",alt:"1.5.webp"}})]),t._v(" "),e("ol",[e("li",[e("p",[t._v("首先定义了变量"),e("code",[t._v("EventStreamContentType")]),t._v("，它的值是"),e("code",[t._v("sse")]),t._v("的"),e("code",[t._v("MIME Type")]),t._v("。它在2个地方使用。第一处是发起请求时设置"),e("code",[t._v("headers.accept")]),t._v("，告诉服务器只接受**"),e("code",[t._v("text/event-stream")]),t._v("**格式的数据。第2处是在连接建立时判断"),e("code",[t._v("response.headers.get('content-type')")]),t._v("是否等于"),e("code",[t._v("EventStreamContentType")]),t._v("的值，如果不是的话就抛出一个错误，声明期待的类型是"),e("code",[t._v("text/event-stream")]),t._v("。")])]),t._v(" "),e("li",[e("p",[t._v("接下来定义了变量"),e("code",[t._v("DefaultRetryInterval")]),t._v("，"),e("code",[t._v("sse")]),t._v("有"),e("strong",[t._v("自动重连")]),t._v("机制，这里定义了每次重连的默认间隔为1s。然后定义了变量"),e("code",[t._v("LastEventId")]),t._v("，表示上一次事件的id，添加在"),e("code",[t._v("headers")]),t._v("中发送到服务端。")])]),t._v(" "),e("li",[e("p",[t._v("接下来定义了一个类型"),e("code",[t._v("FetchEventSourceInit")]),t._v("，它声明了"),e("code",[t._v("fetchEventSource")]),t._v("的第2个参数的类型。参数一共有7个。"),e("br"),t._v(" "),e("code",[t._v("headers")]),t._v(" 请求头。"),e("br"),t._v(" "),e("code",[t._v("onopen")]),t._v(" 连接建立时的回调函数，如果没有设置会调用默认的"),e("code",[t._v("defaultOnOpen")]),t._v("，这个默认回调里进行了返回值类型判断。"),e("br"),t._v(" "),e("code",[t._v("onmessage")]),t._v("每次收到消息时的回调函数，参数是消息对象，它的类型就是"),e("code",[t._v("parse.ts")]),t._v("中定义的"),e("code",[t._v("EventSourceMessage")]),t._v("。"),e("br"),t._v(" "),e("code",[t._v("onclose")]),t._v(" 连接关闭时的回调函数。"),e("br"),t._v(" "),e("code",[t._v("onerror")]),t._v("连接发送错误时的回调函数，如果没有指定这个回调或返回"),e("code",[t._v("undefined")]),t._v("就会发起重新连接请求。"),e("br"),t._v(" "),e("code",[t._v("openWhenHidden")]),t._v(" 默认为"),e("code",[t._v("false")]),t._v("，监听"),e("code",[t._v("visibilitychange")]),t._v("，当页面不可见时关闭连接，当页面重新可见时重新打开连接。"),e("br"),t._v(" "),e("code",[t._v("fetch")]),t._v("发起请求的方法，默认为"),e("code",[t._v("window.fetch")]),t._v("。")]),t._v(" "),e("p",[e("code",[t._v("Record<string, string>")]),t._v("等价于"),e("code",[t._v("{[key: string]: string}")]),e("br"),t._v(" "),e("code",[t._v("Promise<void>")]),t._v("定义了一个异步函数，返回值是"),e("code",[t._v("void")]),e("br"),t._v(" "),e("code",[t._v("typeof fetch")]),t._v(" 获取"),e("code",[t._v("fetch")]),t._v("的类型，"),e("code",[t._v("typeof")]),t._v("后面跟的是变量，表示类型定义")])]),t._v(" "),e("li",[e("p",[t._v("接下来就是最重要的"),e("code",[t._v("fetchEventSource")]),t._v("，它是一个异步函数，接受2个参数："),e("code",[t._v("url")]),t._v("和"),e("code",[t._v("FetchEventSourceInit")]),t._v("类型的对象。"),e("br"),t._v("\n在这个方法中，首先定义了接受的媒体类型。然后添加监听"),e("code",[t._v("visibilitychange")]),t._v("事件，然后添加监听"),e("code",[t._v("abort")]),t._v("事件供使用者可以手动打断连接，然后发起连接，拿到返回值后将返回值传递给"),e("code",[t._v("onopen")]),t._v("，然后调用"),e("code",[t._v("getBytes")]),t._v("解析返回值，解析之后关闭连接。"),e("br"),t._v("\n用"),e("code",[t._v("try...catch")]),t._v("包裹发起连接和解析返回值以及关闭连接的过程，如果捕获到错误且不是主动打断的就发起重连。"),e("br"),t._v("\n再说一下主动打断连接这里，"),e("code",[t._v("fetchEventSource")]),t._v("的第2个参数可以传入一个信号"),e("code",[t._v("signal")]),t._v("，这个属性在"),e("code",[t._v("FetchEventSourceInit")]),t._v("中没有定义。借助"),e("code",[t._v("AbortController")]),t._v("中断连接，具体信息可以看"),e("a",{attrs:{href:"https://developer.mozilla.org/zh-CN/docs/Web/API/AbortController",target:"_blank",rel:"noopener noreferrer"}},[t._v("AbortController-MDN"),e("OutboundLink")],1),t._v("。")])])]),t._v(" "),e("p",[e("code",[t._v("??")]),t._v("类似"),e("code",[t._v("||")]),t._v("，相同点在于根据前面的值判断返回前面的还是后面的，不同点在于"),e("code",[t._v("??")]),t._v("的第一个值为"),e("code",[t._v("null")]),t._v("或"),e("code",[t._v("undefined")]),t._v("时返回第二个值，"),e("code",[t._v("||")]),t._v("会将第一个值先转换为布尔值。比如")]),t._v(" "),e("div",{staticClass:"language- extra-class"},[e("pre",[e("code",[t._v("```\n0 ?? 2 // 0\n0 || 2 // 2\n```\n")])])]),e("p",[t._v("5. "),e("code",[t._v("defaultOnOpen")]),t._v("定义默认"),e("code",[t._v("onopen")]),t._v("回调，主要是检查返回值类型。")]),t._v(" "),e("h1",{attrs:{id:"解析消息"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#解析消息"}},[t._v("#")]),t._v(" 解析消息")]),t._v(" "),e("p",[e("img",{attrs:{src:"https://cdn.jsdelivr.net/gh/chendx97/CPics/img/f8f916378b15441497a3b83ca5ad0fd5~tplv-k3u1fbpfcp-jj-mark:3024:0:0:0:q75.awebp",alt:"2.PNG"}}),t._v("\n首先使用"),e("code",[t._v("response.body")]),t._v("来获取响应的主体内容，并通过"),e("code",[t._v("getBytes")]),t._v("函数将其转换为字节数组。然后，使用"),e("code",[t._v("getLines")]),t._v("函数将字节数组拆分成行，并使用"),e("code",[t._v("getMessages")]),t._v("函数将每行解析为事件消息。")]),t._v(" "),e("h2",{attrs:{id:"处理readablestream数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#处理readablestream数据"}},[t._v("#")]),t._v(" 处理ReadableStream数据")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建了一个数据读取器")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" reader "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" response"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getReader")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建了一个文本解码器")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" decoder "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TextDecoder")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nreader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("processText")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" done"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" value "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Result 对象包含了两个属性：")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// done  - 当 stream 传完所有数据时则变成 true")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// value - 数据片段。当 done 为 true 时始终为 undefined")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("done"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 将字节流转换为字符")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" text "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" decoder"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("decode")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("value"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 内容")]),t._v("\n  console"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("text"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 再次调用这个函数以读取更多数据")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" reader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("read")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("then")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("processText"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n")])])]),e("h2",{attrs:{id:"处理过程分析"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#处理过程分析"}},[t._v("#")]),t._v(" 处理过程分析")]),t._v(" "),e("div",{staticClass:"language-js extra-class"},[e("pre",{pre:!0,attrs:{class:"language-js"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("await")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getBytes")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("response"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getLines")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getMessages")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("id")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// store the id and send it back on the next retry:")]),t._v("\n        headers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("LastEventId"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" id"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// don't send the last-event-id header anymore:")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("delete")]),t._v(" headers"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("LastEventId"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("retry")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    retryInterval "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" retry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" onmessage"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("首先执行的是"),e("code",[t._v("getBytes")]),t._v("方法，它创建一个读取器，用"),e("code",[t._v("while")]),t._v("循环读取流数据，每读取一段就执行"),e("code",[t._v("onChunk")]),t._v("解析流数据，"),e("code",[t._v("onChunk")]),t._v("就是在"),e("code",[t._v("fetch.ts")]),t._v("中"),e("code",[t._v("getLines")]),t._v("的返回值。"),e("br"),t._v(" "),e("code",[t._v("onChunk")]),t._v("将字节块按行分割，并将每行的字节子数组和字段长度传递给"),e("code",[t._v("onLine")]),t._v("回调函数。"),e("code",[t._v("onLine")]),t._v("则是"),e("code",[t._v("getMessages")]),t._v("的返回值。"),e("br"),t._v(" "),e("code",[t._v("getMessages")]),t._v("创建了一个解码器，返回一个名为onLine的函数，用于处理每个传入的行数据。它将行的字节子数组解码为字符串，并根据字段的类型进行相应的处理。比如，如果字段是"),e("code",[t._v("data")]),t._v("，它会将值追加到"),e("code",[t._v("message.data")]),t._v("中，如果"),e("code",[t._v("message.data")]),t._v("已经存在，则在原有值的基础上添加新值，并使用换行符分隔。"),e("br"),t._v("\n将字节流先按行分割再解析是为了更好的处理数据，因为数据都是"),e("code",[t._v("field:value")]),t._v("格式的。")]),t._v(" "),e("p",[e("code",[t._v("TextDecoder")]),t._v("表示一个文本解码器，可以将字节流数据转换成指定码位流，默认是utf-8。")]),t._v(" "),e("h1",{attrs:{id:"问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),e("p",[t._v("在调试这个库的时候，在"),e("code",[t._v("html")]),t._v("中引入打包后的"),e("code",[t._v("esm")]),t._v("文件会报错文件找不到，因为文件名没有添加后缀。"),e("br"),t._v("\n接口返回值的类型必须是"),e("code",[t._v("text/event-stream")]),t._v("类型的，就算是流数据也不行。")]),t._v(" "),e("h1",{attrs:{id:"总结"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[t._v("#")]),t._v(" 总结")]),t._v(" "),e("p",[e("code",[t._v("getBytes")]),t._v("的第2个参数是"),e("code",[t._v("getLines")]),t._v("的返回值，"),e("code",[t._v("getLines")]),t._v("的参数又是"),e("code",[t._v("getMessages")]),t._v("的返回值，嵌套的比较深。"),e("br"),t._v(" "),e("code",[t._v("onChunk")]),t._v("将字节块切割成一行一行的字节，涉及字节数据的知识。")])])}),[],!1,null,null,null);e.default=n.exports}}]);